# CloudFlare セキュリティ強化ガイド

## 🔐 APIトークンベースの認証への移行（推奨）

### なぜAPIトークンが安全か？
- **スコープ限定**: 必要な権限のみを付与
- **期限設定**: 自動期限切れでリスク軽減
- **監査ログ**: 使用状況の追跡が可能
- **IP制限**: 特定IPからのみアクセス許可

### APIトークンの作成手順

1. **CloudFlareダッシュボード** → **マイプロファイル** → **APIトークン**
2. **カスタムトークンを作成** をクリック
3. 以下の設定を推奨：

```
トークン名: OwnServer Manager Token
権限:
  - Zone : Zone : Read (ゾーン情報の読み取り)
  - Zone : DNS : Edit (DNSレコードの編集)

ゾーンリソース:
  - Include : Specific zone : あなたのドメイン名

クライアントIP アドレスフィルタリング（推奨）:
  - サーバーの固定IPアドレスのみを許可

TTL（Time To Live）:
  - 90日または1年（必要に応じて）
```

### 4. **トークンテスト**
```bash
# 生成したトークンをテスト
curl -X GET "https://api.cloudflare.com/client/v4/zones" \
     -H "Authorization: Bearer YOUR_NEW_API_TOKEN" \
     -H "Content-Type: application/json"
```

## 🔒 追加セキュリティ対策

### 1. IP制限の設定
- サーバーの固定IPアドレスからのみAPIアクセスを許可
- VPNやプロキシ経由でのアクセスを制限

### 2. 定期的なローテーション
- APIトークンを3ヶ月〜6ヶ月ごとに更新
- 古いトークンは即座に削除

### 3. 監査ログの確認
- CloudFlareの監査ログで不審なAPI利用を監視
- 異常なアクセスパターンがないか定期チェック

### 4. 最小権限の原則
- 必要最小限の権限のみを付与
- 読み書き権限を分離（可能な場合）

## 🚨 Zone ID流出時の対策

Zone IDが流出していても、以下により影響を軽減：

### ✅ 実施済み/実施中
- [x] 古いAPIトークンの無効化
- [x] Global API Keyの変更
- [ ] スコープ限定APIトークンへの移行

### 📊 リスク評価
- **低リスク**: Zone IDのみでは DNS操作は不可能
- **中リスク**: 他の認証情報と組み合わせて悪用される可能性
- **対策**: 強固な認証とアクセス制御で十分防御可能

## 🎯 結論

**Zone IDの変更は不要です。**
適切なAPI認証管理により、十分なセキュリティを確保できます。

1. ✅ **新しいAPIトークン**を作成（スコープ限定）
2. ✅ **IP制限**を設定
3. ✅ **定期的なローテーション**スケジュールを作成
4. ✅ **監査ログ**の定期確認

これらの対策により、Zone ID流出のリスクを最小化できます。
